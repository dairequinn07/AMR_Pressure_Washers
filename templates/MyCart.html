{% extends 'base.html' %}

{% block head %}
    {{ super() }}
    <!-- Include Square's Payment Form SDK -->
    <script src="https://js.squareup.com/v2/paymentform.js" async onload="initializePaymentForm()" onerror="handleSdkError()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
{% endblock %}

{% block body %}
    {{ super() }}
    <section id="cart-page">
        <h1 class="cart-title" style="text-align: center;">Your Cart</h1>
        <div class="cart-layout">
            <!-- Cart Items Section -->
            <div class="cart-items">
                {% if cart %}
                    {% for item in cart %}
                        <div class="cart-item">
                            <div class="cart-item-image">
                                <img src="{{ item['ImageURLs'] }}" alt="{{ item['Name'] }}">
                            </div>
                            <div class="cart-item-details">
                                <h2 class="cs-text">{{ item['Name'] }}</h2>
                                <p class="cs-price">£{{ item['Price'] }}</p>
                            </div>
                            <div class="cart-item-controls">
                                <button class="decrease-btn">-</button>
                                <span class="cart-item-quantity" style="color: black;">{{ item['Quantity'] }}</span>
                                <button class="increase-btn">+</button>
                                <button class="remove-btn">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Your cart is empty!</p>
                {% endif %}
            </div>

            <!-- Order Summary Section -->
            <div class="order-summary">
                <h2>Order Summary</h2>
                <div class="summary-item">
                    <span>Subtotal</span>
                    <span>£{{ subtotal }}</span>
                </div>
                <div class="summary-item">
                    <span>Delivery Fee</span>
                    <span>£30</span>
                </div>
                <div class="summary-item total">
                    <span>Total</span>
                    <span>£{{ subtotal + 30 }}</span>
                </div>
                <div class="promo-code">
                    <input type="text" placeholder="Add promo code">
                    <button>Apply</button>
                </div>
                <button class="checkout-btn" onclick="startCheckout()">Go to Checkout →</button>

                <!-- Payment Form -->
                <form id="payment-form">
                    <div id="card-container"></div>  <!-- This is where the Square card form will appear -->
                    <button id="card-button" type="button" onclick="processPayment()">Pay £{{ subtotal + 30 }}</button>
                </form>
                <div id="payment-status-container"></div>  <!-- This is where you will show payment status messages -->
            </div>
        </div>
    </section>

    <script>
        let paymentForm; // Declare the paymentForm variable globally

        // Initialize the payment form when the SDK script is fully loaded
        function initializePaymentForm() {
            if (window.SqPaymentForm) {
                paymentForm = new SqPaymentForm({
                    applicationId: 'sandbox-sq0idb-Lo9MxUF6efqCduIDwLO14A',  // Replace with your Square application ID
                    locationId: 'LS1HEYMHR59Q5',  // Replace with your Square location ID
                    inputClass: 'sq-input',  // Style your form inputs
                    inputStyles: [{
                        fontSize: '.9em',
                        padding: '.5em',
                        backgroundColor: 'transparent',
                        color: 'black',
                        border: '1px solid #ccc',
                        borderRadius: '4px',
                        boxShadow: 'none',
                    }],
                    card: {
                        elementId: 'card-container',
                        placeholder: 'Card number',
                    },
                    callbacks: {
                        paymentFormLoaded: function() {
                            console.log("Payment form is loaded.");
                        },
                        cardNonceResponseReceived: function(errors, nonce, cardData) {
                            if (errors) {
                                // Handle validation errors
                                console.error(errors);
                                return;
                            }
                            // Send the nonce to your backend to process the payment
                            processPayment(nonce);
                        }
                    }
                });
                paymentForm.build();
            } else {
                console.error("Square SDK is not loaded correctly.");
            }
        }

        // Handle errors if the SDK fails to load
        function handleSdkError() {
            console.error("Error loading the Square SDK. Please check your internet connection.");
            alert("Error loading payment form. Please try again later.");
        }

        // Start the payment process when the checkout button is clicked
        function startCheckout() {
            if (!paymentForm) {
                console.log("Initializing payment form...");
                initializePaymentForm();
            } else {
                console.log("Payment form already initialized.");
                paymentForm.build(); // Rebuild the form if already initialized
            }
        }

        // Handle the payment process on the frontend
        function processPayment(nonce) {
            if (!nonce) {
                alert("Payment information is missing!");
                return;
            }
            // Send the nonce to your backend for processing
            fetch('/process-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nonce: nonce,
                    amount: {{ subtotal + 30 }}  // Total amount in your chosen currency
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('payment-status-container').innerHTML = "Payment successful!";
                } else {
                    document.getElementById('payment-status-container').innerHTML = "Payment failed.";
                }
            })
            .catch(err => {
                document.getElementById('payment-status-container').innerHTML = "Error processing payment.";
                console.error(err);
            });
        }
    </script>
{% endblock %}